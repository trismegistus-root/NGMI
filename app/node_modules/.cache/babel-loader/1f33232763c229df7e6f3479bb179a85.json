{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\n\nvar ethereumjs_common_1 = require(\"ethereumjs-common\");\n\nvar buffer_1 = require(\"buffer\"); // secp256k1n/2\n\n\nvar N_DIV_2 = new ethereumjs_util_1.BN('7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0', 16);\n/**\r\n * An Ethereum transaction.\r\n */\n\nvar Transaction =\n/** @class */\nfunction () {\n  /**\r\n   * Creates a new transaction from an object with its fields' values.\r\n   *\r\n   * @param data - A transaction can be initialized with its rlp representation, an array containing\r\n   * the value of its fields in order, or an object containing them by name.\r\n   *\r\n   * @param opts - The transaction's options, used to indicate the chain and hardfork the\r\n   * transactions belongs to.\r\n   *\r\n   * @note Transaction objects implement EIP155 by default. To disable it, use the constructor's\r\n   * second parameter to set a chain and hardfork before EIP155 activation (i.e. before Spurious\r\n   * Dragon.)\r\n   *\r\n   * @example\r\n   * ```js\r\n   * const txData = {\r\n   *   nonce: '0x00',\r\n   *   gasPrice: '0x09184e72a000',\r\n   *   gasLimit: '0x2710',\r\n   *   to: '0x0000000000000000000000000000000000000000',\r\n   *   value: '0x00',\r\n   *   data: '0x7f7465737432000000000000000000000000000000000000000000000000000000600057',\r\n   *   v: '0x1c',\r\n   *   r: '0x5e1d3a76fbf824220eafc8c79ad578ad2b67d01b0c2425eb1f1347e8f50882ab',\r\n   *   s: '0x5bd428537f05f9830e93792f90ea6a3e2d1ee84952dd96edbae9f658f831ab13'\r\n   * };\r\n   * const tx = new Transaction(txData);\r\n   * ```\r\n   */\n  function Transaction(data, opts) {\n    if (data === void 0) {\n      data = {};\n    }\n\n    if (opts === void 0) {\n      opts = {};\n    } // instantiate Common class instance based on passed options\n\n\n    if (opts.common) {\n      if (opts.chain || opts.hardfork) {\n        throw new Error('Instantiation with both opts.common, and opts.chain and opts.hardfork parameter not allowed!');\n      }\n\n      this._common = opts.common;\n    } else {\n      var chain = opts.chain ? opts.chain : 'mainnet';\n      var hardfork = opts.hardfork ? opts.hardfork : 'petersburg';\n      this._common = new ethereumjs_common_1.default(chain, hardfork);\n    } // Define Properties\n\n\n    var fields = [{\n      name: 'nonce',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'gasPrice',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'gasLimit',\n      alias: 'gas',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'to',\n      allowZero: true,\n      length: 20,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'value',\n      length: 32,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'data',\n      alias: 'input',\n      allowZero: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'v',\n      allowZero: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 'r',\n      length: 32,\n      allowZero: true,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }, {\n      name: 's',\n      length: 32,\n      allowZero: true,\n      allowLess: true,\n      default: new buffer_1.Buffer([])\n    }]; // attached serialize\n\n    ethereumjs_util_1.defineProperties(this, fields, data);\n    /**\r\n     * @property {Buffer} from (read only) sender address of this transaction, mathematically derived from other parameters.\r\n     * @name from\r\n     * @memberof Transaction\r\n     */\n\n    Object.defineProperty(this, 'from', {\n      enumerable: true,\n      configurable: true,\n      get: this.getSenderAddress.bind(this)\n    });\n\n    this._validateV(this.v);\n\n    this._overrideVSetterWithValidation();\n  }\n  /**\r\n   * If the tx's `to` is to the creation address\r\n   */\n\n\n  Transaction.prototype.toCreationAddress = function () {\n    return this.to.toString('hex') === '';\n  };\n  /**\r\n   * Computes a sha3-256 hash of the serialized tx\r\n   * @param includeSignature - Whether or not to include the signature\r\n   */\n\n\n  Transaction.prototype.hash = function (includeSignature) {\n    if (includeSignature === void 0) {\n      includeSignature = true;\n    }\n\n    var items;\n\n    if (includeSignature) {\n      items = this.raw;\n    } else {\n      if (this._implementsEIP155()) {\n        items = this.raw.slice(0, 6).concat([ethereumjs_util_1.toBuffer(this.getChainId()), // TODO: stripping zeros should probably be a responsibility of the rlp module\n        ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)), ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0))]);\n      } else {\n        items = this.raw.slice(0, 6);\n      }\n    } // create hash\n\n\n    return ethereumjs_util_1.rlphash(items);\n  };\n  /**\r\n   * returns chain ID\r\n   */\n\n\n  Transaction.prototype.getChainId = function () {\n    return this._common.chainId();\n  };\n  /**\r\n   * returns the sender's address\r\n   */\n\n\n  Transaction.prototype.getSenderAddress = function () {\n    if (this._from) {\n      return this._from;\n    }\n\n    var pubkey = this.getSenderPublicKey();\n    this._from = ethereumjs_util_1.publicToAddress(pubkey);\n    return this._from;\n  };\n  /**\r\n   * returns the public key of the sender\r\n   */\n\n\n  Transaction.prototype.getSenderPublicKey = function () {\n    if (!this.verifySignature()) {\n      throw new Error('Invalid Signature');\n    } // If the signature was verified successfully the _senderPubKey field is defined\n\n\n    return this._senderPubKey;\n  };\n  /**\r\n   * Determines if the signature is valid\r\n   */\n\n\n  Transaction.prototype.verifySignature = function () {\n    var msgHash = this.hash(false); // All transaction signatures whose s-value is greater than secp256k1n/2 are considered invalid.\n\n    if (this._common.gteHardfork('homestead') && new ethereumjs_util_1.BN(this.s).cmp(N_DIV_2) === 1) {\n      return false;\n    }\n\n    try {\n      var v = ethereumjs_util_1.bufferToInt(this.v);\n\n      var useChainIdWhileRecoveringPubKey = v >= this.getChainId() * 2 + 35 && this._common.gteHardfork('spuriousDragon');\n\n      this._senderPubKey = ethereumjs_util_1.ecrecover(msgHash, v, this.r, this.s, useChainIdWhileRecoveringPubKey ? this.getChainId() : undefined);\n    } catch (e) {\n      return false;\n    }\n\n    return !!this._senderPubKey;\n  };\n  /**\r\n   * sign a transaction with a given private key\r\n   * @param privateKey - Must be 32 bytes in length\r\n   */\n\n\n  Transaction.prototype.sign = function (privateKey) {\n    // We clear any previous signature before signing it. Otherwise, _implementsEIP155's can give\n    // different results if this tx was already signed.\n    this.v = new buffer_1.Buffer([]);\n    this.s = new buffer_1.Buffer([]);\n    this.r = new buffer_1.Buffer([]);\n    var msgHash = this.hash(false);\n    var sig = ethereumjs_util_1.ecsign(msgHash, privateKey);\n\n    if (this._implementsEIP155()) {\n      sig.v += this.getChainId() * 2 + 8;\n    }\n\n    Object.assign(this, sig);\n  };\n  /**\r\n   * The amount of gas paid for the data in this tx\r\n   */\n\n\n  Transaction.prototype.getDataFee = function () {\n    var data = this.raw[5];\n    var cost = new ethereumjs_util_1.BN(0);\n\n    for (var i = 0; i < data.length; i++) {\n      data[i] === 0 ? cost.iaddn(this._common.param('gasPrices', 'txDataZero')) : cost.iaddn(this._common.param('gasPrices', 'txDataNonZero'));\n    }\n\n    return cost;\n  };\n  /**\r\n   * the minimum amount of gas the tx must have (DataFee + TxFee + Creation Fee)\r\n   */\n\n\n  Transaction.prototype.getBaseFee = function () {\n    var fee = this.getDataFee().iaddn(this._common.param('gasPrices', 'tx'));\n\n    if (this._common.gteHardfork('homestead') && this.toCreationAddress()) {\n      fee.iaddn(this._common.param('gasPrices', 'txCreation'));\n    }\n\n    return fee;\n  };\n  /**\r\n   * the up front amount that an account must have for this transaction to be valid\r\n   */\n\n\n  Transaction.prototype.getUpfrontCost = function () {\n    return new ethereumjs_util_1.BN(this.gasLimit).imul(new ethereumjs_util_1.BN(this.gasPrice)).iadd(new ethereumjs_util_1.BN(this.value));\n  };\n\n  Transaction.prototype.validate = function (stringError) {\n    if (stringError === void 0) {\n      stringError = false;\n    }\n\n    var errors = [];\n\n    if (!this.verifySignature()) {\n      errors.push('Invalid Signature');\n    }\n\n    if (this.getBaseFee().cmp(new ethereumjs_util_1.BN(this.gasLimit)) > 0) {\n      errors.push([\"gas limit is too low. Need at least \" + this.getBaseFee()]);\n    }\n\n    if (stringError === false) {\n      return errors.length === 0;\n    } else {\n      return errors.join(' ');\n    }\n  };\n  /**\r\n   * Returns the rlp encoding of the transaction\r\n   */\n\n\n  Transaction.prototype.serialize = function () {\n    // Note: This never gets executed, defineProperties overwrites it.\n    return ethereumjs_util_1.rlp.encode(this.raw);\n  };\n  /**\r\n   * Returns the transaction in JSON format\r\n   * @see {@link https://github.com/ethereumjs/ethereumjs-util/blob/master/docs/index.md#defineproperties|ethereumjs-util}\r\n   */\n\n\n  Transaction.prototype.toJSON = function (labels) {\n    if (labels === void 0) {\n      labels = false;\n    } // Note: This never gets executed, defineProperties overwrites it.\n\n\n    return {};\n  };\n\n  Transaction.prototype._validateV = function (v) {\n    if (v === undefined || v.length === 0) {\n      return;\n    }\n\n    if (!this._common.gteHardfork('spuriousDragon')) {\n      return;\n    }\n\n    var vInt = ethereumjs_util_1.bufferToInt(v);\n\n    if (vInt === 27 || vInt === 28) {\n      return;\n    }\n\n    var isValidEIP155V = vInt === this.getChainId() * 2 + 35 || vInt === this.getChainId() * 2 + 36;\n\n    if (!isValidEIP155V) {\n      throw new Error(\"Incompatible EIP155-based V \" + vInt + \" and chain id \" + this.getChainId() + \". See the second parameter of the Transaction constructor to set the chain id.\");\n    }\n  };\n\n  Transaction.prototype._isSigned = function () {\n    return this.v.length > 0 && this.r.length > 0 && this.s.length > 0;\n  };\n\n  Transaction.prototype._overrideVSetterWithValidation = function () {\n    var _this = this;\n\n    var vDescriptor = Object.getOwnPropertyDescriptor(this, 'v');\n    Object.defineProperty(this, 'v', __assign({}, vDescriptor, {\n      set: function (v) {\n        if (v !== undefined) {\n          _this._validateV(ethereumjs_util_1.toBuffer(v));\n        }\n\n        vDescriptor.set(v);\n      }\n    }));\n  };\n\n  Transaction.prototype._implementsEIP155 = function () {\n    var onEIP155BlockOrLater = this._common.gteHardfork('spuriousDragon');\n\n    if (!this._isSigned()) {\n      // We sign with EIP155 all unsigned transactions after spuriousDragon\n      return onEIP155BlockOrLater;\n    } // EIP155 spec:\n    // If block.number >= 2,675,000 and v = CHAIN_ID * 2 + 35 or v = CHAIN_ID * 2 + 36, then when computing\n    // the hash of a transaction for purposes of signing or recovering, instead of hashing only the first six\n    // elements (i.e. nonce, gasprice, startgas, to, value, data), hash nine elements, with v replaced by\n    // CHAIN_ID, r = 0 and s = 0.\n\n\n    var v = ethereumjs_util_1.bufferToInt(this.v);\n    var vAndChainIdMeetEIP155Conditions = v === this.getChainId() * 2 + 35 || v === this.getChainId() * 2 + 36;\n    return vAndChainIdMeetEIP155Conditions && onEIP155BlockOrLater;\n  };\n\n  return Transaction;\n}();\n\nexports.default = Transaction;","map":{"version":3,"sources":["../src/transaction.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\r\nvar ethereumjs_common_1 = require(\"ethereumjs-common\");\r\nvar buffer_1 = require(\"buffer\");\r\n// secp256k1n/2\r\nvar N_DIV_2 = new ethereumjs_util_1.BN('7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0', 16);\r\n/**\r\n * An Ethereum transaction.\r\n */\r\nvar Transaction = /** @class */ (function () {\r\n    /**\r\n     * Creates a new transaction from an object with its fields' values.\r\n     *\r\n     * @param data - A transaction can be initialized with its rlp representation, an array containing\r\n     * the value of its fields in order, or an object containing them by name.\r\n     *\r\n     * @param opts - The transaction's options, used to indicate the chain and hardfork the\r\n     * transactions belongs to.\r\n     *\r\n     * @note Transaction objects implement EIP155 by default. To disable it, use the constructor's\r\n     * second parameter to set a chain and hardfork before EIP155 activation (i.e. before Spurious\r\n     * Dragon.)\r\n     *\r\n     * @example\r\n     * ```js\r\n     * const txData = {\r\n     *   nonce: '0x00',\r\n     *   gasPrice: '0x09184e72a000',\r\n     *   gasLimit: '0x2710',\r\n     *   to: '0x0000000000000000000000000000000000000000',\r\n     *   value: '0x00',\r\n     *   data: '0x7f7465737432000000000000000000000000000000000000000000000000000000600057',\r\n     *   v: '0x1c',\r\n     *   r: '0x5e1d3a76fbf824220eafc8c79ad578ad2b67d01b0c2425eb1f1347e8f50882ab',\r\n     *   s: '0x5bd428537f05f9830e93792f90ea6a3e2d1ee84952dd96edbae9f658f831ab13'\r\n     * };\r\n     * const tx = new Transaction(txData);\r\n     * ```\r\n     */\r\n    function Transaction(data, opts) {\r\n        if (data === void 0) { data = {}; }\r\n        if (opts === void 0) { opts = {}; }\r\n        // instantiate Common class instance based on passed options\r\n        if (opts.common) {\r\n            if (opts.chain || opts.hardfork) {\r\n                throw new Error('Instantiation with both opts.common, and opts.chain and opts.hardfork parameter not allowed!');\r\n            }\r\n            this._common = opts.common;\r\n        }\r\n        else {\r\n            var chain = opts.chain ? opts.chain : 'mainnet';\r\n            var hardfork = opts.hardfork ? opts.hardfork : 'petersburg';\r\n            this._common = new ethereumjs_common_1.default(chain, hardfork);\r\n        }\r\n        // Define Properties\r\n        var fields = [\r\n            {\r\n                name: 'nonce',\r\n                length: 32,\r\n                allowLess: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'gasPrice',\r\n                length: 32,\r\n                allowLess: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'gasLimit',\r\n                alias: 'gas',\r\n                length: 32,\r\n                allowLess: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'to',\r\n                allowZero: true,\r\n                length: 20,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'value',\r\n                length: 32,\r\n                allowLess: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'data',\r\n                alias: 'input',\r\n                allowZero: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'v',\r\n                allowZero: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 'r',\r\n                length: 32,\r\n                allowZero: true,\r\n                allowLess: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n            {\r\n                name: 's',\r\n                length: 32,\r\n                allowZero: true,\r\n                allowLess: true,\r\n                default: new buffer_1.Buffer([]),\r\n            },\r\n        ];\r\n        // attached serialize\r\n        ethereumjs_util_1.defineProperties(this, fields, data);\r\n        /**\r\n         * @property {Buffer} from (read only) sender address of this transaction, mathematically derived from other parameters.\r\n         * @name from\r\n         * @memberof Transaction\r\n         */\r\n        Object.defineProperty(this, 'from', {\r\n            enumerable: true,\r\n            configurable: true,\r\n            get: this.getSenderAddress.bind(this),\r\n        });\r\n        this._validateV(this.v);\r\n        this._overrideVSetterWithValidation();\r\n    }\r\n    /**\r\n     * If the tx's `to` is to the creation address\r\n     */\r\n    Transaction.prototype.toCreationAddress = function () {\r\n        return this.to.toString('hex') === '';\r\n    };\r\n    /**\r\n     * Computes a sha3-256 hash of the serialized tx\r\n     * @param includeSignature - Whether or not to include the signature\r\n     */\r\n    Transaction.prototype.hash = function (includeSignature) {\r\n        if (includeSignature === void 0) { includeSignature = true; }\r\n        var items;\r\n        if (includeSignature) {\r\n            items = this.raw;\r\n        }\r\n        else {\r\n            if (this._implementsEIP155()) {\r\n                items = this.raw.slice(0, 6).concat([\r\n                    ethereumjs_util_1.toBuffer(this.getChainId()),\r\n                    // TODO: stripping zeros should probably be a responsibility of the rlp module\r\n                    ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)),\r\n                    ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)),\r\n                ]);\r\n            }\r\n            else {\r\n                items = this.raw.slice(0, 6);\r\n            }\r\n        }\r\n        // create hash\r\n        return ethereumjs_util_1.rlphash(items);\r\n    };\r\n    /**\r\n     * returns chain ID\r\n     */\r\n    Transaction.prototype.getChainId = function () {\r\n        return this._common.chainId();\r\n    };\r\n    /**\r\n     * returns the sender's address\r\n     */\r\n    Transaction.prototype.getSenderAddress = function () {\r\n        if (this._from) {\r\n            return this._from;\r\n        }\r\n        var pubkey = this.getSenderPublicKey();\r\n        this._from = ethereumjs_util_1.publicToAddress(pubkey);\r\n        return this._from;\r\n    };\r\n    /**\r\n     * returns the public key of the sender\r\n     */\r\n    Transaction.prototype.getSenderPublicKey = function () {\r\n        if (!this.verifySignature()) {\r\n            throw new Error('Invalid Signature');\r\n        }\r\n        // If the signature was verified successfully the _senderPubKey field is defined\r\n        return this._senderPubKey;\r\n    };\r\n    /**\r\n     * Determines if the signature is valid\r\n     */\r\n    Transaction.prototype.verifySignature = function () {\r\n        var msgHash = this.hash(false);\r\n        // All transaction signatures whose s-value is greater than secp256k1n/2 are considered invalid.\r\n        if (this._common.gteHardfork('homestead') && new ethereumjs_util_1.BN(this.s).cmp(N_DIV_2) === 1) {\r\n            return false;\r\n        }\r\n        try {\r\n            var v = ethereumjs_util_1.bufferToInt(this.v);\r\n            var useChainIdWhileRecoveringPubKey = v >= this.getChainId() * 2 + 35 && this._common.gteHardfork('spuriousDragon');\r\n            this._senderPubKey = ethereumjs_util_1.ecrecover(msgHash, v, this.r, this.s, useChainIdWhileRecoveringPubKey ? this.getChainId() : undefined);\r\n        }\r\n        catch (e) {\r\n            return false;\r\n        }\r\n        return !!this._senderPubKey;\r\n    };\r\n    /**\r\n     * sign a transaction with a given private key\r\n     * @param privateKey - Must be 32 bytes in length\r\n     */\r\n    Transaction.prototype.sign = function (privateKey) {\r\n        // We clear any previous signature before signing it. Otherwise, _implementsEIP155's can give\r\n        // different results if this tx was already signed.\r\n        this.v = new buffer_1.Buffer([]);\r\n        this.s = new buffer_1.Buffer([]);\r\n        this.r = new buffer_1.Buffer([]);\r\n        var msgHash = this.hash(false);\r\n        var sig = ethereumjs_util_1.ecsign(msgHash, privateKey);\r\n        if (this._implementsEIP155()) {\r\n            sig.v += this.getChainId() * 2 + 8;\r\n        }\r\n        Object.assign(this, sig);\r\n    };\r\n    /**\r\n     * The amount of gas paid for the data in this tx\r\n     */\r\n    Transaction.prototype.getDataFee = function () {\r\n        var data = this.raw[5];\r\n        var cost = new ethereumjs_util_1.BN(0);\r\n        for (var i = 0; i < data.length; i++) {\r\n            data[i] === 0\r\n                ? cost.iaddn(this._common.param('gasPrices', 'txDataZero'))\r\n                : cost.iaddn(this._common.param('gasPrices', 'txDataNonZero'));\r\n        }\r\n        return cost;\r\n    };\r\n    /**\r\n     * the minimum amount of gas the tx must have (DataFee + TxFee + Creation Fee)\r\n     */\r\n    Transaction.prototype.getBaseFee = function () {\r\n        var fee = this.getDataFee().iaddn(this._common.param('gasPrices', 'tx'));\r\n        if (this._common.gteHardfork('homestead') && this.toCreationAddress()) {\r\n            fee.iaddn(this._common.param('gasPrices', 'txCreation'));\r\n        }\r\n        return fee;\r\n    };\r\n    /**\r\n     * the up front amount that an account must have for this transaction to be valid\r\n     */\r\n    Transaction.prototype.getUpfrontCost = function () {\r\n        return new ethereumjs_util_1.BN(this.gasLimit).imul(new ethereumjs_util_1.BN(this.gasPrice)).iadd(new ethereumjs_util_1.BN(this.value));\r\n    };\r\n    Transaction.prototype.validate = function (stringError) {\r\n        if (stringError === void 0) { stringError = false; }\r\n        var errors = [];\r\n        if (!this.verifySignature()) {\r\n            errors.push('Invalid Signature');\r\n        }\r\n        if (this.getBaseFee().cmp(new ethereumjs_util_1.BN(this.gasLimit)) > 0) {\r\n            errors.push([\"gas limit is too low. Need at least \" + this.getBaseFee()]);\r\n        }\r\n        if (stringError === false) {\r\n            return errors.length === 0;\r\n        }\r\n        else {\r\n            return errors.join(' ');\r\n        }\r\n    };\r\n    /**\r\n     * Returns the rlp encoding of the transaction\r\n     */\r\n    Transaction.prototype.serialize = function () {\r\n        // Note: This never gets executed, defineProperties overwrites it.\r\n        return ethereumjs_util_1.rlp.encode(this.raw);\r\n    };\r\n    /**\r\n     * Returns the transaction in JSON format\r\n     * @see {@link https://github.com/ethereumjs/ethereumjs-util/blob/master/docs/index.md#defineproperties|ethereumjs-util}\r\n     */\r\n    Transaction.prototype.toJSON = function (labels) {\r\n        if (labels === void 0) { labels = false; }\r\n        // Note: This never gets executed, defineProperties overwrites it.\r\n        return {};\r\n    };\r\n    Transaction.prototype._validateV = function (v) {\r\n        if (v === undefined || v.length === 0) {\r\n            return;\r\n        }\r\n        if (!this._common.gteHardfork('spuriousDragon')) {\r\n            return;\r\n        }\r\n        var vInt = ethereumjs_util_1.bufferToInt(v);\r\n        if (vInt === 27 || vInt === 28) {\r\n            return;\r\n        }\r\n        var isValidEIP155V = vInt === this.getChainId() * 2 + 35 || vInt === this.getChainId() * 2 + 36;\r\n        if (!isValidEIP155V) {\r\n            throw new Error(\"Incompatible EIP155-based V \" + vInt + \" and chain id \" + this.getChainId() + \". See the second parameter of the Transaction constructor to set the chain id.\");\r\n        }\r\n    };\r\n    Transaction.prototype._isSigned = function () {\r\n        return this.v.length > 0 && this.r.length > 0 && this.s.length > 0;\r\n    };\r\n    Transaction.prototype._overrideVSetterWithValidation = function () {\r\n        var _this = this;\r\n        var vDescriptor = Object.getOwnPropertyDescriptor(this, 'v');\r\n        Object.defineProperty(this, 'v', __assign({}, vDescriptor, { set: function (v) {\r\n                if (v !== undefined) {\r\n                    _this._validateV(ethereumjs_util_1.toBuffer(v));\r\n                }\r\n                vDescriptor.set(v);\r\n            } }));\r\n    };\r\n    Transaction.prototype._implementsEIP155 = function () {\r\n        var onEIP155BlockOrLater = this._common.gteHardfork('spuriousDragon');\r\n        if (!this._isSigned()) {\r\n            // We sign with EIP155 all unsigned transactions after spuriousDragon\r\n            return onEIP155BlockOrLater;\r\n        }\r\n        // EIP155 spec:\r\n        // If block.number >= 2,675,000 and v = CHAIN_ID * 2 + 35 or v = CHAIN_ID * 2 + 36, then when computing\r\n        // the hash of a transaction for purposes of signing or recovering, instead of hashing only the first six\r\n        // elements (i.e. nonce, gasprice, startgas, to, value, data), hash nine elements, with v replaced by\r\n        // CHAIN_ID, r = 0 and s = 0.\r\n        var v = ethereumjs_util_1.bufferToInt(this.v);\r\n        var vAndChainIdMeetEIP155Conditions = v === this.getChainId() * 2 + 35 || v === this.getChainId() * 2 + 36;\r\n        return vAndChainIdMeetEIP155Conditions && onEIP155BlockOrLater;\r\n    };\r\n    return Transaction;\r\n}());\r\nexports.default = Transaction;\r\n//# sourceMappingURL=transaction.js.map"]},"metadata":{},"sourceType":"script"}